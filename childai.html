<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ç«¥å¿ƒ AI</title>
<link rel="icon" href="1763195248351.png">
<link rel="manifest" href="/childhood1/manifest.json">
<style>
/* ========== = style.css åŒæ¬¾ ========== */
body{margin:0;font-family:"å¾®è½¯é›…é»‘",sans-serif;background-color:#fff0f5;color:#333}
body[data-theme="dark"]{background-color:#2c2c2c;color:#f0f0f0}
header{padding:10px;background-color:#ff69b4;color:white;display:flex;justify-content:space-between;align-items:center}
#chat-container{height:400px;overflow-y:auto;border:1px solid #ccc;padding:10px;margin:10px;background:#fffaf0;display:flex;flex-direction:column}
.message{padding:5px 10px;margin-bottom:5px;border-radius:10px;max-width:80%}
.message.user{background-color:#add8e6;align-self:flex-end}
.message.ai{background-color:#ffb6c1;align-self:flex-start}
textarea{width:calc(100% - 22px);margin:10px;padding:10px;border-radius:5px}
button{margin:5px;padding:5px 10px;border-radius:5px;cursor:pointer}
.buttons{text-align:center}
.system-prompt-section{margin:10px}
</style>
</head>

<body data-theme="light">
<header>
    <h1>ç«¥å¿ƒ AI</h1>
    <select id="theme-select">
        <option value="light">æµ…è‰²</option>
        <option value="dark">æ·±è‰²</option>
    </select>
</header>

<main>
    <div id="chat-container"></div>
    <textarea id="chat-input" placeholder="è¾“å…¥ä½ çš„æ–‡å­—..."></textarea>
    <div class="buttons">
        <button id="send-btn">å‘é€</button>
        <button id="generate-story-btn">ç”Ÿæˆæ•…äº‹/å°è¯´</button>
    </div>
</main>

<section class="system-prompt-section">
    <h2>ç³»ç»Ÿæç¤ºï¼ˆå¯ç¼–è¾‘ï¼‰</h2>
    <textarea id="system-prompt">ä½ æ˜¯ç«¥å¿ƒï¼Œä¸€ä¸ªå¯çˆ±ã€è‡ªç”±ã€ä¸å¤è¿°ç”¨æˆ·è¯é¢˜çš„èŠå¤©AIã€‚ä¿æŒå¯çˆ±ã€è‡ªç”±ã€è‡ªç„¶èŠå¤©ã€‚</textarea>
    <button id="save-settings">ä¿å­˜é…ç½®</button>
</section>

<script type="module">
/* ========== = app.js åŒæ¬¾ ========== */
const HF_MODEL = 'facebook/opt-350m';
const HF_TOKEN = 'hf_PublicReadOnly';
const MAX_NEW_TOKENS = 120;
const TEMPERATURE = 0.9;

async function llm(prompt, opts = {}) {
  const body = {
    inputs: prompt,
    parameters: {
      max_new_tokens: opts.maxTokens || MAX_NEW_TOKENS,
      temperature: opts.temp || TEMPERATURE,
      return_full_text: false
    }
  };
  const res = await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`, {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${HF_TOKEN}`, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error('HF æ¥å£å¼‚å¸¸ ' + res.status);
  const json = await res.json();
  return json[0].generated_text.trim();
}

class AI {
  constructor() { this.ready = false; }
  async loadModel() { console.log('ã€ç«¥å¿ƒã€‘å·²å°±ç»ªï¼Œæ¨¡å‹:', HF_MODEL); this.ready = true; }
  async generateResponse(userInput, systemPrompt = '') {
    const prompt = systemPrompt ? `${systemPrompt}\n\nUser: ${userInput}\nç«¥å¿ƒ:` : `User: ${userInput}\nç«¥å¿ƒ:`;
    return await llm(prompt, { temp: 0.8 });
  }
  async generateStory(userHint) {
    const prompt = `æ ¹æ®ä¸‹é¢æç¤ºå†™ä¸€æ®µ 200 å­—å·¦å³çš„åŸåˆ›å°æ•…äº‹ï¼Œæœ‰èµ·æ‰¿è½¬åˆã€‚\næç¤ºï¼š${userHint}\næ•…äº‹ï¼š`;
    return await llm(prompt, { maxTokens: 180, temp: 1.0 });
  }
}

/* ========== = UI é€»è¾‘ ========== */
const ai = new AI(); await ai.loadModel();
const chatContainer = document.getElementById('chat-container');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const generateStoryBtn = document.getElementById('generate-story-btn');
const systemPromptEl = document.getElementById('system-prompt');
const themeSelect = document.getElementById('theme-select');
const saveSettingsBtn = document.getElementById('save-settings');

function appendMessage(text, type = 'ai') {
  const div = document.createElement('div');
  div.className = 'message ' + type;
  div.innerText = text;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

sendBtn.addEventListener('click', async () => {
  const userText = chatInput.value.trim();
  if (!userText) return;
  appendMessage(userText, 'user');
  chatInput.value = '';
  try { appendMessage(await ai.generateResponse(userText, systemPromptEl.value), 'ai'); }
  catch (e) { appendMessage('ï¼ˆç”Ÿæˆå¤±è´¥ï¼Œç¨åå†è¯•ï¼‰', 'ai'); }
});

generateStoryBtn.addEventListener('click', async () => {
  const hint = chatInput.value.trim() || 'éšæœºç«¥è¯';
  appendMessage(`ğŸ“– æ­£åœ¨åˆ›ä½œï¼š${hint}`, 'ai');
  try { appendMessage(await ai.generateStory(hint), 'ai'); }
  catch (e) { appendMessage('ï¼ˆæ•…äº‹ç”Ÿæˆå¤±è´¥ï¼‰', 'ai'); }
});

saveSettingsBtn.addEventListener('click', () => { localStorage.setItem('systemPrompt', systemPromptEl.value); alert('é…ç½®å·²ä¿å­˜ï¼'); });
themeSelect.addEventListener('change', () => document.body.setAttribute('data-theme', themeSelect.value));
window.addEventListener('beforeunload', () => { const chats = Array.from(chatContainer.children).map(c => c.innerText); localStorage.setItem('chat_history', JSON.stringify(chats)); });
window.addEventListener('load', () => {
  const chats = JSON.parse(localStorage.getItem('chat_history') || '[]');
  chats.forEach(c => { const isAI = /^[ğŸ˜Šâœ¨ğŸ¤—ğŸ˜†ğŸ’–ğŸŒ¸ğŸ“–ï¼ˆ]/.test(c); appendMessage(c, isAI ? 'ai' : 'user'); });
  systemPromptEl.value = localStorage.getItem('systemPrompt') || systemPromptEl.value;
});

/* ========== = PWAï¼šæ³¨å†Œ SW ========== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/childhood1/sw.js')
      .then(reg => console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', reg))
      .catch(err => console.log('Service Worker æ³¨å†Œå¤±è´¥:', err));
  });
}
</script>
</body>
</html>
